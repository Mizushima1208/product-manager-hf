<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機械台帳</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Noto+Serif+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css?v=10">
</head>
<body>
    <div class="washi-overlay"></div>
    <div class="sakura-deco top-right"></div>
    <div class="wave-deco bottom-left"></div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">機</div>
                <div class="logo-text">機械<span>台帳</span></div>
            </div>
            <nav class="main-nav">
                <a href="#" class="nav-link active" data-page="equipment">機械管理</a>
                <a href="#" class="nav-link" data-page="signboards">工事看板</a>
            </nav>
            <button class="btn btn-ghost btn-icon" id="settings-btn" title="設定">⚙️</button>
        </div>
    </header>

    <!-- 機械管理ページ -->
    <div id="equipment-page" class="page-content active">
    <div class="main-container">
        <div class="main-content">
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title">📤 Google ドライブから銘板写真を取込</div>
                </div>
                <div class="card-body">
                    <div class="drive-section">
                        <div class="drive-status">
                            <span class="status-dot" id="drive-status-indicator"></span>
                            <span id="drive-status-text">状態を確認中...</span>
                        </div>
                        <div class="drive-actions">
                            <button class="btn btn-secondary" id="load-drive-files-btn">📂 ファイル読込</button>
                            <button class="btn btn-primary" id="process-all-btn" disabled>⚡ 全て処理</button>
                            <button class="btn btn-secondary" id="import-json-btn" title="JSONファイルから機械情報をインポート">📥 JSON読込</button>
                            <button class="btn btn-ghost" id="test-api-btn" title="API接続テスト">🔧 APIテスト</button>
                        </div>
                        <div id="api-usage-display" style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 600;">📊 Cloud Vision API</span>
                                <span id="api-usage-count" style="font-size: 0.9rem;">処理数: 0</span>
                            </div>
                            <div style="background: var(--border); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div id="api-usage-bar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                無料枠: 1,000画像/月 |
                                <a href="https://console.cloud.google.com/apis/api/vision.googleapis.com/metrics" target="_blank" style="color: var(--primary);">Google Cloudで使用量確認</a>
                            </div>
                        </div>
                        <div id="api-test-result" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 0.85rem;"></div>
                        <div class="drive-files" id="drive-files" style="display: none;"></div>
                        <div class="progress-container" id="progress-container">
                            <div class="progress-header"><span>処理中...</span><span id="progress-count">0 / 0</span></div>
                            <div class="progress-bar-wrapper"><div class="progress-bar" id="progress-bar"></div></div>
                            <div class="progress-info" id="current-file-info">
                                <span class="spinner-small"></span><span id="current-file-name">準備中...</span>
                            </div>
                            <div class="progress-errors" id="progress-errors" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">📋 機械一覧</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="equipment-sort-select" class="sort-select" style="padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem; background: var(--bg-secondary);">
                            <option value="created_at-desc">登録日 (新しい順)</option>
                            <option value="created_at-asc">登録日 (古い順)</option>
                            <option value="equipment_name-asc">名前 (A→Z)</option>
                            <option value="equipment_name-desc">名前 (Z→A)</option>
                            <option value="manufacturer-asc">メーカー (A→Z)</option>
                            <option value="manufacturer-desc">メーカー (Z→A)</option>
                        </select>
                        <button class="btn btn-ghost btn-sm" id="refresh-btn">🔄 更新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="equipment-list"></div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="card">
                <div class="card-body">
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-info">
                            <h3 id="equipment-count">0</h3>
                            <p>登録機械数</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">📥 JSON一括読込</div></div>
                <div class="card-body">
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">data/json-import フォルダから一括読み込み</p>
                    <button class="btn btn-primary" id="import-all-json-btn" style="width: 100%;">📥 一括インポート</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">🔍 製品画像検索</div></div>
                <div class="card-body">
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">画像未設定の機器をWeb検索</p>
                    <button class="btn btn-primary" id="bulk-fetch-images-btn" style="width: 100%;">🔍 一括画像検索</button>
                    <div id="bulk-image-progress" style="display: none; margin-top: 12px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px;">
                            <span id="bulk-image-status">検索中...</span>
                            <span id="bulk-image-count">0 / 0</span>
                        </div>
                        <div style="background: var(--border); border-radius: 4px; height: 6px; overflow: hidden;">
                            <div id="bulk-image-bar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="bulk-image-current" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;"></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">クイック操作</div></div>
                <div class="card-body">
                    <div class="quick-actions">
                        <button class="quick-action-btn danger" id="clear-all-btn">🗑️ 全データを削除</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 工事看板管理ページ -->
    <div id="signboards-page" class="page-content">
    <div class="main-container">
        <div class="main-content">
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <div class="card-title">📋 工事看板一覧</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary btn-sm" id="add-signboard-btn">➕ 新規登録</button>
                        <button class="btn btn-ghost btn-sm" id="refresh-signboards-btn">🔄 更新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="signboards-list"></div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="card">
                <div class="card-body">
                    <div class="stat-card">
                        <div class="stat-icon">🪧</div>
                        <div class="stat-info">
                            <h3 id="signboards-count">0</h3>
                            <p>登録看板数</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">在庫サマリー</div></div>
                <div class="card-body">
                    <div id="signboards-summary">
                        <div class="summary-item">
                            <span class="summary-label">在庫あり</span>
                            <span class="summary-value" id="summary-instock">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">使用中</span>
                            <span class="summary-value" id="summary-inuse">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">修理中</span>
                            <span class="summary-value" id="summary-repair">0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><div class="card-title">クイック操作</div></div>
                <div class="card-body">
                    <div class="quick-actions">
                        <button class="quick-action-btn" id="view-history-btn">📋 入出庫履歴を見る</button>
                        <button class="quick-action-btn danger" id="clear-all-signboards-btn">🗑️ 全データを削除</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- OCR結果モーダル -->
    <div class="modal-overlay" id="ocr-result-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">📝 OCR読み取り結果</div>
                <button class="modal-close" id="close-ocr-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; gap: 16px;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0; font-size: 0.9rem;">📷 処理画像</h4>
                        <div id="ocr-image-container" style="max-height: 300px; overflow: hidden; border-radius: 8px; background: var(--bg-secondary);">
                            <img id="ocr-result-image" src="" alt="処理画像" style="width: 100%; height: auto; display: block;">
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0; font-size: 0.9rem;">📄 OCRテキスト</h4>
                        <div id="ocr-raw-text" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--border);">
                <h4 style="margin: 0 0 8px 0; font-size: 0.9rem;">🔍 抽出結果</h4>
                <div id="ocr-extracted-info" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;"></div>
            </div>
        </div>
    </div>

    <!-- 入出庫履歴モーダル -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">📋 入出庫履歴</div>
                <button class="modal-close" id="close-history-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label">看板でフィルター</label>
                    <select class="form-input" id="history-filter-signboard">
                        <option value="">すべて表示</option>
                    </select>
                </div>
                <div id="history-list" style="max-height: 400px; overflow-y: auto;">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 工事看板 新規登録/編集モーダル -->
    <div class="modal-overlay" id="signboard-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title" id="signboard-modal-title">🪧 工事看板登録</div>
                <button class="modal-close" id="close-signboard-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <div class="form-group">
                        <label class="form-label">テンプレート画像から選択</label>
                        <div id="signboard-templates-container">
                            <div id="signboard-templates-loading" style="text-align: center; padding: 10px; color: #666;">
                                📂 テンプレート読み込み中...
                            </div>
                            <div id="signboard-templates-grid" class="template-grid" style="display: none;"></div>
                            <div id="signboard-templates-error" style="display: none; color: var(--danger); padding: 10px;"></div>
                        </div>
                        <input type="hidden" id="signboard-template-id" value="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">または画像をアップロード</label>
                        <input type="file" class="form-input" id="signboard-image-upload" accept="image/*">
                        <div id="signboard-image-preview" style="margin-top: 8px;"></div>
                    </div>
                    <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--border);">
                    <div class="form-group">
                        <label class="form-label">看板記載内容 <span style="color: var(--danger);">*</span></label>
                        <input type="text" class="form-input" id="signboard-comment" placeholder="例: 作業中・立入禁止">
                    </div>
                    <div class="form-group">
                        <label class="form-label">説明・備考</label>
                        <textarea class="form-input" id="signboard-description" rows="2" placeholder="例: 赤文字の大きい看板"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">サイズ</label>
                            <input type="text" class="form-input" id="signboard-size" placeholder="例: A3, 600x900mm">
                        </div>
                        <div class="form-group">
                            <label class="form-label">数量</label>
                            <input type="number" class="form-input" id="signboard-quantity" value="1" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">保管場所</label>
                            <input type="text" class="form-input" id="signboard-location" placeholder="例: 倉庫A棚3段目">
                        </div>
                        <div class="form-group">
                            <label class="form-label">状態</label>
                            <select class="form-input" id="signboard-status">
                                <option value="在庫あり">在庫あり</option>
                                <option value="使用中">使用中</option>
                                <option value="修理中">修理中</option>
                                <option value="廃棄予定">廃棄予定</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">メモ</label>
                        <textarea class="form-input" id="signboard-notes" rows="2" placeholder="自由記入"></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancel-signboard-btn">キャンセル</button>
                    <button class="btn btn-primary" id="save-signboard-btn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">⚙️ 設定</div>
                <button class="modal-close" id="close-settings">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 処理エンジン設定 -->
                <div class="settings-section">
                    <div class="settings-section-header" data-section="engine">
                        <span>🔍 処理エンジン</span>
                        <span class="settings-toggle">▼</span>
                    </div>
                    <div class="settings-section-content" id="engine-section">
                        <div class="engine-selector" id="engine-selector"></div>
                    </div>
                </div>

                <!-- Google Vision API設定 -->
                <div class="settings-section">
                    <div class="settings-section-header" data-section="vision">
                        <span>👁️ Google Vision API (高精度OCR)</span>
                        <span class="settings-toggle">▼</span>
                    </div>
                    <div class="settings-section-content" id="vision-section">
                        <div class="settings-status-bar">
                            <span class="status-dot" id="vision-status-dot"></span>
                            <span id="vision-status-text">確認中...</span>
                        </div>

                        <div id="vision-account-info" style="display: none; margin-bottom: 16px;">
                            <div class="detail-item" style="margin-bottom: 8px;">
                                <div class="detail-label">紐づけアカウント</div>
                                <div class="detail-value" id="vision-client-email">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">プロジェクトID</div>
                                <div class="detail-value" id="vision-project-id">-</div>
                            </div>
                        </div>

                        <div class="settings-instructions">
                            <div class="instructions-title">📋 設定手順</div>
                            <ol class="instructions-list">
                                <li><a href="https://console.cloud.google.com/apis/library/vision.googleapis.com" target="_blank">Cloud Vision API</a> を有効化</li>
                                <li><a href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank">サービスアカウント</a> を作成</li>
                                <li>キーを作成 → JSON形式でダウンロード</li>
                                <li>下にアップロード</li>
                            </ol>
                            <p class="instructions-note">※ 料金: 1,000枚まで無料、以降 $1.50/1,000枚</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">サービスアカウントキー (JSON)</label>
                            <div class="credentials-drop" id="vision-credentials-upload">
                                <input type="file" id="vision-credentials-input" accept=".json">
                                <div class="credentials-drop-icon">🔑</div>
                                <p id="vision-credentials-status">クリックしてサービスアカウントキーをアップロード</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 編集モーダル -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">✏️ 機械情報編集</div>
                <button class="modal-close" id="close-edit-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <div class="form-group">
                        <label class="form-label">製品名</label>
                        <input type="text" class="form-input" id="edit-equipment-name" placeholder="例: プレートコンパクター">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">型番</label>
                            <input type="text" class="form-input" id="edit-model-number" placeholder="例: MVC-F60">
                        </div>
                        <div class="form-group">
                            <label class="form-label">シリアル番号</label>
                            <input type="text" class="form-input" id="edit-serial-number" placeholder="例: W 5290">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">購入日</label>
                            <input type="date" class="form-input" id="edit-purchase-date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">工具種別</label>
                            <select class="form-input" id="edit-tool-category">
                                <option value="">選択してください</option>
                                <option value="プレートコンパクター">プレートコンパクター</option>
                                <option value="ランマー">ランマー</option>
                                <option value="バイブレーター">バイブレーター</option>
                                <option value="発電機">発電機</option>
                                <option value="溶接機">溶接機</option>
                                <option value="コンプレッサー">コンプレッサー</option>
                                <option value="ブレーカー">ブレーカー</option>
                                <option value="ドリル">ドリル</option>
                                <option value="カッター">カッター</option>
                                <option value="ポンプ">ポンプ</option>
                                <option value="チェーンソー">チェーンソー</option>
                                <option value="草刈機">草刈機</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">メーカー</label>
                        <input type="text" class="form-input" id="edit-manufacturer" placeholder="例: 三笠産業">
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancel-edit-btn">キャンセル</button>
                    <button class="btn btn-primary" id="save-edit-btn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 機械詳細モーダル -->
    <div class="modal-overlay" id="equipment-detail-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">🏭 機械詳細</div>
                <button class="modal-close" id="close-detail-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-content">
                    <div class="detail-image">
                        <img id="detail-image" src="" alt="機械画像" onerror="this.style.display='none'">
                        <button class="btn btn-secondary btn-sm" id="fetch-image-btn" style="margin-top: 8px; width: 100%;">🔍 製品画像を検索</button>
                    </div>
                    <div class="detail-info">
                        <div class="detail-item">
                            <div class="detail-label">製品名</div>
                            <div class="detail-value" id="detail-name">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">型番</div>
                            <div class="detail-value" id="detail-model">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">シリアル番号</div>
                            <div class="detail-value" id="detail-serial">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">メーカー</div>
                            <div class="detail-value" id="detail-manufacturer">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">工具種別</div>
                            <div class="detail-value" id="detail-category">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">購入日</div>
                            <div class="detail-value" id="detail-purchase-date">-</div>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">📝 メモ</label>
                    <textarea class="form-input" id="detail-notes" rows="4" placeholder="この機械に関するメモを入力..."></textarea>
                </div>
                <div class="search-manual-section">
                    <button class="btn btn-search" id="search-spec-btn">📋 仕様書を検索</button>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="detail-edit-btn">✏️ 編集</button>
                    <button class="btn btn-danger" id="detail-delete-btn">🗑️ 削除</button>
                    <button class="btn btn-primary" id="detail-save-notes-btn">💾 メモを保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 検索結果モーダル -->
    <div class="modal-overlay" id="search-results-modal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title" id="search-results-title">📚 検索結果</div>
                <button class="modal-close" id="close-search-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="search-query-info" id="search-query-info"></div>
                <div class="search-results-list" id="search-results-list">
                    <div class="search-loading">
                        <div class="spinner"></div>
                        <p>検索中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/main.js?v=22"></script>
</body>
</html>
